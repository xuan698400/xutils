<?xml version="1.0" encoding="UTF-8" ?>
<bpm code="bpm.BuyerQueryFirstReviewProcess" name="买家获取推荐商品" type="process" description="买家获取推荐商品流程">
    <var name="context" description="上下文"
         dataType="com.alibaba.halo2.capability.review.trade.scenario.buyer.query.BuyerRecommendItemsAndReviewsContext"
         inOutType="param"/>
    <var name="result" description="返回值" dataType="com.alibaba.halo2.capability.review.trade.session.ActionResult"
         inOutType="return"/>
    <start id="1" name="开始" g="100,0,50,50">
        <transition g=":-15,20" to="2"/>
    </start>
    <end id="10000" name="结束" g="95,565,50,50"/>
    <decision id="2" name="获取推荐商品" g="100,200,50,50">
        <transition expression="result.isSuccess()" name="推荐成功" priority="" to="99"/>
        <transition name="推荐失败" to="4"/>
        <action type="spring-bean">
            <actionHandle bean="buyerRecommendItemsAction"
                          clazz="com.alibaba.halo2.capability.review.trade.action.buyer.query.recommend.BuyerRecommendItemsAction"
                          method="process">
                <var name="param" dataType="BuyerRecommendItemsAndReviewsContext" contextVarName="context"
                     inOutType="param"/>
                <var name="returnValue" dataType="ActionResult" contextVarName="result" inOutType="return"/>
            </actionHandle>
        </action>
    </decision>
    <loopProcess id="99" name="循环节点" g="385,140,198,190" collectionVarName="context.getItemsAndReviewsDTOList()"
                 variableName="eachRecommendItem" indexVarName="i"
                 variableClass="com.alibaba.halo2.share.model.review.recommend.dto.ItemsAndReviewsDTO"
                 startNodeId="99-1" endNodeId="99-99">
        <transition name="循环结束" to="4"/>
        <decision id="99-1" name="设置首条查询参数" g="40,35,50,50">
            <transition expression="result.isSuccess()" name="成功" to="99-2"/>
            <transition name="错误" to="99-99"/>
            <action type="spring-bean">
                <actionHandle bean="buyerRecommendFirstFillQueryParamAction"
                              clazz="com.alibaba.halo2.capability.review.trade.action.buyer.query.recommend.BuyerRecommendFirstFillQueryParamAction"
                              method="process">
                    <var name="param" dataType="BuyerRecommendItemsAndReviewsContext" contextVarName="context"
                         inOutType="param"/>
                    <var name="returnValue" dataType="ActionResult" contextVarName="result" inOutType="return"/>
                </actionHandle>
            </action>
        </decision>
        <decision id="99-2" name="是否屏蔽展示评价" g="45,125,50,50">
            <transition expression="result.isSuccess()" name="成功" to="99-3"/>
            <transition name="错误" to="99-99"/>
            <action type="spring-bean">
                <actionHandle bean="buyerRecommendFirstBlockAction"
                              clazz="com.alibaba.halo2.capability.review.trade.action.buyer.query.recommend.BuyerRecommendFirstBlockAction"
                              method="process">
                    <var name="param" dataType="BuyerRecommendItemsAndReviewsContext" contextVarName="context"
                         inOutType="param"/>
                    <var name="recommendItem" dataType="ItemsAndReviewsDTO" contextVarName="eachRecommendItem"
                         inOutType="param"/>
                    <var name="returnValue" dataType="ActionResult" contextVarName="result" inOutType="return"/>
                </actionHandle>
            </action>
        </decision>
        <decision id="99-3" name="查询评价缓存数据" g="45,225,50,50">
            <transition expression="result.isJump()" name="命中缓存" priority="" to="99-99"/>
            <transition expression="result.isSuccess()" name="未命中缓存" to="99-4"/>
            <transition name="错误" to="99-99"/>
            <action type="spring-bean">
                <actionHandle bean="buyerRecommendFirstGetFromCacheAction"
                              clazz="com.alibaba.halo2.capability.review.trade.action.buyer.query.recommend.BuyerRecommendFirstGetFromCacheAction"
                              method="process">
                    <var name="param" dataType="BuyerRecommendItemsAndReviewsContext" contextVarName="context"
                         inOutType="param"/>
                    <var name="returnValue" dataType="ActionResult" contextVarName="result" inOutType="return"/>
                </actionHandle>
            </action>
        </decision>
        <decision id="99-4" name="查询首条评价数据" g="45,325,50,50">
            <transition expression="result.isSuccess()" name="成功" to="99-5"/>
            <transition name="错误" to="99-99"/>
            <action type="spring-bean">
                <actionHandle bean="buyerRecommendFirstGetFirstAction"
                              clazz="com.alibaba.halo2.capability.review.trade.action.buyer.query.recommend.BuyerRecommendFirstGetFirstAction"
                              method="process">
                    <var name="param" dataType="BuyerRecommendItemsAndReviewsContext" contextVarName="context"
                         inOutType="param"/>
                    <var name="returnValue" dataType="ActionResult" contextVarName="result" inOutType="return"/>
                </actionHandle>
            </action>
        </decision>
        <decision id="99-5" name="评价内容填充" g="45,435,50,50">
            <transition expression="result.isSuccess()" name="成功" to="99-6"/>
            <transition name="错误" to="99-99"/>
            <action type="spring-bean">
                <actionHandle bean="buyerRecommendFirstFillContentAction"
                              clazz="com.alibaba.halo2.capability.review.trade.action.buyer.query.recommend.BuyerRecommendFirstFillContentAction"
                              method="process">
                    <var name="param" dataType="BuyerRecommendItemsAndReviewsContext" contextVarName="context"
                         inOutType="param"/>
                    <var name="returnValue" dataType="ActionResult" contextVarName="result" inOutType="return"/>
                </actionHandle>
            </action>
        </decision>
        <decision id="99-6" name="用户信息填充" g="45,550,50,50">
            <transition expression="result.isSuccess()" name="成功" to="99-7"/>
            <transition name="错误" to="99-99"/>
            <action type="spring-bean">
                <actionHandle bean="buyerRecommendFirstFillUserAction"
                              clazz="com.alibaba.halo2.capability.review.trade.action.buyer.query.recommend.BuyerRecommendFirstFillUserAction"
                              method="process">
                    <var name="param" dataType="BuyerRecommendItemsAndReviewsContext" contextVarName="context"
                         inOutType="param"/>
                    <var name="returnValue" dataType="ActionResult" contextVarName="result" inOutType="return"/>
                </actionHandle>
            </action>
        </decision>
        <decision id="99-7" name="统计信息结果处理" g="45,680,50,50">
            <transition expression="result.isSuccess()" name="成功" to="99-8"/>
            <transition name="错误" to="99-99"/>
            <action type="spring-bean">
                <actionHandle bean="buyerRecommendFirstStatisticResultProcessAction"
                              clazz="com.alibaba.halo2.capability.review.trade.action.buyer.query.recommend.BuyerRecommendFirstStatisticResultProcessAction"
                              method="process">
                    <var name="param" dataType="BuyerRecommendItemsAndReviewsContext" contextVarName="context"
                         inOutType="param"/>
                    <var name="returnValue" dataType="ActionResult" contextVarName="result" inOutType="return"/>
                </actionHandle>
            </action>
        </decision>
        <decision id="99-8" name="填充其他业务信息" g="40,795,50,50">
            <transition expression="result.isSuccess()" name="成功" to="99-9"/>
            <transition name="错误" to="99-99"/>
            <action type="spring-bean">
                <actionHandle bean="buyerRecommendFirstFillOtherInfoAction"
                              clazz="com.alibaba.halo2.capability.review.trade.action.buyer.query.recommend.BuyerRecommendFirstFillOtherInfoAction"
                              method="process">
                    <var name="param" dataType="BuyerRecommendItemsAndReviewsContext" contextVarName="context"
                         inOutType="param"/>
                    <var name="returnValue" dataType="ActionResult" contextVarName="result" inOutType="return"/>
                </actionHandle>
            </action>
        </decision>
        <decision id="99-9" name="首条缓存结果组装构建" g="35,920,50,50">
            <transition expression="result.isSuccess()" name="成功" to="99-10"/>
            <transition name="错误" to="99-99"/>
            <action type="spring-bean">
                <actionHandle bean="buyerRecommendFirstCacheResultBuildAction"
                              clazz="com.alibaba.halo2.capability.review.trade.action.buyer.query.recommend.BuyerRecommendFirstCacheResultBuildAction"
                              method="process">
                    <var name="param" dataType="BuyerRecommendItemsAndReviewsContext" contextVarName="context"
                         inOutType="param"/>
                    <var name="returnValue" dataType="ActionResult" contextVarName="result" inOutType="return"/>
                </actionHandle>
            </action>
        </decision>
        <decision id="99-10" name="首条结果缓存写入" g="35,1040,50,50">
            <transition expression="result.isSuccess()" name="成功" to="99-99"/>
            <transition name="错误" to="99-99"/>
            <action type="spring-bean">
                <actionHandle bean="buyerRecommendFirstPutCacheAction"
                              clazz="com.alibaba.halo2.capability.review.trade.action.buyer.query.recommend.BuyerRecommendFirstPutCacheAction"
                              method="process">
                    <var name="param" dataType="BuyerRecommendItemsAndReviewsContext" contextVarName="context"
                         inOutType="param"/>
                    <var name="returnValue" dataType="ActionResult" contextVarName="result" inOutType="return"/>
                </actionHandle>
            </action>
        </decision>
        <autoTask id="99-99" name="循环结束空节点" g="245,1210,50,50">
            <action type="spring-bean">
                <actionHandle bean="buyerRecommendEmptyAction"
                              clazz="com.alibaba.halo2.capability.review.trade.action.buyer.query.recommend.BuyerRecommendEmptyAction"
                              method="process">
                    <var name="param" dataType="BuyerRecommendItemsAndReviewsContext" contextVarName="context"
                         inOutType="param"/>
                    <var name="returnValue" dataType="ActionResult" contextVarName="result" inOutType="return"/>
                </actionHandle>
            </action>
        </autoTask>
    </loopProcess>
    <autoTask id="4" name="推荐结果封装" g="95,425,50,50">
        <transition to="10000"/>
        <action type="spring-bean">
            <actionHandle bean="buyerRecommendResultBuildAction"
                          clazz="com.alibaba.halo2.capability.review.trade.action.buyer.query.recommend.BuyerRecommendResultBuildAction"
                          method="process">
                <var name="param" dataType="BuyerRecommendItemsAndReviewsContext" contextVarName="context"
                     inOutType="param"/>
                <var name="returnValue" dataType="ActionResult" contextVarName="result" inOutType="return"/>
            </actionHandle>
        </action>
    </autoTask>
</bpm>
